<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>綠色商店後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar-item { transition: all 0.2s ease-in-out; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #10B981; color: white; transform: translateX(4px); }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-content { max-height: 85vh; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-200">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center text-gray-800">後台管理登入</h2>
                <div class="pt-4">
                    <button id="loginButton" class="w-full flex items-center justify-center px-4 py-2 font-semibold text-white bg-emerald-600 rounded-md hover:bg-emerald-700">
                        <i class="fab fa-google mr-2"></i> 使用 Google 登入
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="flex h-screen bg-gray-100">
                <!-- Sidebar -->
                <div class="w-64 bg-gray-800 text-white flex flex-col">
                    <div class="px-8 py-6 text-2xl font-bold">管理系統</div>
                    <nav class="flex-1 px-4 py-4 space-y-2">
                        <a href="#" data-section="mainDashboard" class="sidebar-item active flex items-center px-4 py-2 rounded-md"><i class="fas fa-tachometer-alt w-6"></i>儀表板</a>
                        <a href="#" data-section="subscribers" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-users w-6"></i>訂閱者管理</a>
                        <a href="#" data-section="announcements" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-bullhorn w-6"></i>公告管理</a>
                        <a href="#" data-section="policies" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-file-alt w-6"></i>政策管理</a>
                        <a href="#" data-section="shops" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-store w-6"></i>店家管理</a>
                        <a href="#" data-section="trash" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-trash-alt w-6"></i>垃圾桶</a>
                    </nav>
                    <div class="px-4 py-4"><button id="logoutButton" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"><i class="fas fa-sign-out-alt mr-2"></i>登出</button></div>
                </div>

                <!-- Main Content -->
                <main class="flex-1 p-8 overflow-y-auto" id="mainContent"></main>
            </div>
        </div>
    </div>
    
    <!-- Modals and Indicators -->
    <div id="loadingIndicator" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-25"><div class="spinner h-16 w-16 border-4 border-gray-300 rounded-full"></div></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden"></div>
    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-[1001] flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-red-700 text-center mb-4">發生錯誤</h3>
            <div class="bg-red-50 p-4 rounded-md max-h-80 overflow-y-auto"><pre id="errorDetails" class="text-xs text-left text-gray-800 whitespace-pre-wrap break-all"></pre></div>
            <div class="mt-4 text-center"><button id="closeErrorModal" class="px-6 py-2 bg-red-600 text-white text-base font-medium rounded-md">關閉</button></div>
        </div>
    </div>
    <!-- Generic Form Modal -->
    <div id="formModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800"></h3>
                <button id="closeModalButtonX" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto modal-content"></div>
            <div class="p-4 bg-gray-50 rounded-b-lg flex justify-end gap-4">
                <button id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">取消</button>
                <button id="saveModalButton" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700">儲存</button>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSy...",
      authDomain: "greenroof-8951b.firebaseapp.com",
      projectId: "greenroof-8951b",
      storageBucket: "greenroof-8951b.appspot.com",
      messagingSenderId: "505320924738",
      appId: "1:505320924738:web:19318b7462725f776269c3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const ui = {
        loginScreen: document.getElementById('loginScreen'),
        dashboard: document.getElementById('dashboard'),
        loginForm: document.getElementById('loginForm'),
        logoutButton: document.getElementById('logoutButton'),
        sidebarItems: document.querySelectorAll('.sidebar-item'),
        mainContent: document.getElementById('mainContent'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        toast: document.getElementById('toast'),
        errorModal: document.getElementById('errorModal'),
        errorDetails: document.getElementById('errorDetails'),
        closeErrorModal: document.getElementById('closeErrorModal'),
        formModal: document.getElementById('formModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalBody: document.getElementById('modalBody'),
        closeModalButton: document.getElementById('closeModalButton'),
        closeModalButtonX: document.getElementById('closeModalButtonX'),
        saveModalButton: document.getElementById('saveModalButton'),
    };

    const showToast = (message) => {
        ui.toast.textContent = message;
        ui.toast.classList.remove('hidden');
        setTimeout(() => ui.toast.classList.add('hidden'), 3000);
    };

    const showErrorModal = (error) => {
        let details = `錯誤類型: ${error.name || '未知錯誤'}\n`;
        details += `錯誤訊息: ${error.message}\n\n`;
        if (error.stack) { details += `堆疊追蹤:\n${error.stack}`; }
        ui.errorDetails.textContent = details;
        ui.errorModal.classList.remove('hidden');
    };

    const login = async () => {
        try {
            const result = await auth.signInWithPopup(googleProvider);
            const user = result.user;
            if (!user) return;

            // Check if the user is an admin
            const adminDoc = await db.collection('admins').doc(user.uid).get();
            if (adminDoc.exists) {
                // User is an admin, show the dashboard
                ui.loginScreen.classList.add('hidden');
                ui.dashboard.classList.remove('hidden');
                navigateTo('mainDashboard');
            } else {
                // Not an admin, show error and sign out
                showErrorModal(new Error("您沒有權限存取這個後台。"));
                await auth.signOut();
            }
        } catch (error) {
            showErrorModal(error);
            await auth.signOut();
        }
    };

    const logout = async () => {
        await auth.signOut();
        ui.dashboard.classList.add('hidden');
        ui.loginScreen.classList.remove('hidden');
        ui.mainContent.innerHTML = '';
    };

    const checkLogin = () => {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in, verify they are an admin
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (adminDoc.exists) {
                    ui.loginScreen.classList.add('hidden');
                    ui.dashboard.classList.remove('hidden');
                    navigateTo('mainDashboard');
                } else {
                    // Not an admin, force sign out and show login screen
                    await auth.signOut();
                    ui.dashboard.classList.add('hidden');
                    ui.loginScreen.classList.remove('hidden');
                }
            } else {
                // User is signed out
                ui.dashboard.classList.add('hidden');
                ui.loginScreen.classList.remove('hidden');
            }
        });
    };

    const openModal = (title, bodyHtml, saveHandler) => {
        ui.modalTitle.textContent = title;
        ui.modalBody.innerHTML = bodyHtml;
        ui.formModal.classList.remove('hidden');
        const newSaveButton = ui.saveModalButton.cloneNode(true);
        ui.saveModalButton.parentNode.replaceChild(newSaveButton, ui.saveModalButton);
        ui.saveModalButton = newSaveButton;
        ui.saveModalButton.onclick = saveHandler;
    };

    const closeModal = () => ui.formModal.classList.add('hidden');
    
    const openShopForm = async (shopId = null) => {
        let shop = {};
        if (shopId) {
            const doc = await db.collection('shops').doc(shopId).get();
            if (doc.exists) {
                shop = { id: doc.id, ...doc.data() };
            } else {
                return showErrorModal(new Error("找不到指定的店家。"));
            }
        }

        const title = shopId ? '編輯店家' : '新增店家';
        const formHtml = `
            <form id="shopForm" class="space-y-4">
                <input type="hidden" id="shopId" value="${shop.id || ''}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block">名稱 (繁中)</label><input type="text" id="name_zh-TW" class="w-full border p-2 rounded" value="${shop['name_zh-TW'] || ''}" required></div>
                    <div><label class="block">名稱 (English)</label><input type="text" id="name_en" class="w-full border p-2 rounded" value="${shop['name_en'] || ''}"></div>
                    <div><label class="block">類型 (繁中)</label><input type="text" id="type_zh-TW" class="w-full border p-2 rounded" value="${shop['type_zh-TW'] || ''}"></div>
                    <div><label class="block">類型 (English)</label><input type="text" id="type_en" class="w-full border p-2 rounded" value="${shop['type_en'] || ''}"></div>
                    <div><label class="block">地址 (繁中)</label><input type="text" id="address_zh-TW" class="w-full border p-2 rounded" value="${shop['address_zh-TW'] || ''}"></div>
                    <div><label class="block">地址 (English)</label><input type="text" id="address_en" class="w-full border p-2 rounded" value="${shop['address_en'] || ''}"></div>
                    <div><label class="block">電話</label><input type="text" id="phone" class="w-full border p-2 rounded" value="${shop.phone || ''}"></div>
                    <div><label class="block">網站</label><input type="text" id="website" class="w-full border p-2 rounded" value="${shop.website || ''}"></div>
                    <div><label class="block">緯度 (Lat)</label><input type="text" id="lat" class="w-full border p-2 rounded" value="${shop.lat || ''}"></div>
                    <div><label class="block">經度 (Lng)</label><input type="text" id="lng" class="w-full border p-2 rounded" value="${shop.lng || ''}"></div>
                </div>
                <div><label class="block">簡短描述 (繁中)</label><textarea id="description_zh-TW" class="w-full border p-2 rounded h-24">${shop['description_zh-TW'] || ''}</textarea></div>
                <div><label class="block">長描述 (繁中)</label><textarea id="longDescription_zh-TW" class="w-full border p-2 rounded h-24">${shop['longDescription_zh-TW'] || ''}</textarea></div>
                <div><label class="block">簡短描述 (English)</label><textarea id="description_en" class="w-full border p-2 rounded h-24">${shop['description_en'] || ''}</textarea></div>
                <div><label class="block">長描述 (English)</label><textarea id="longDescription_en" class="w-full border p-2 rounded h-24">${shop['longDescription_en'] || ''}</textarea></div>
            </form>`;
        openModal(title, formHtml, saveShop);
    };

    const saveShop = async () => {
        const form = document.getElementById('shopForm');
        const shopId = form.querySelector('#shopId').value;

        const shopData = {
            'name_zh-TW': form.querySelector('#name_zh-TW').value,
            'name_en': form.querySelector('#name_en').value,
            'type_zh-TW': form.querySelector('#type_zh-TW').value,
            'type_en': form.querySelector('#type_en').value,
            'address_zh-TW': form.querySelector('#address_zh-TW').value,
            'address_en': form.querySelector('#address_en').value,
            'phone': form.querySelector('#phone').value,
            'website': form.querySelector('#website').value,
            'lat': form.querySelector('#lat').value,
            'lng': form.querySelector('#lng').value,
            'description_zh-TW': form.querySelector('#description_zh-TW').value,
            'longDescription_zh-TW': form.querySelector('#longDescription_zh-TW').value,
            'description_en': form.querySelector('#description_en').value,
            'longDescription_en': form.querySelector('#longDescription_en').value,
        };

        try {
            if (shopId) {
                await db.collection('shops').doc(shopId).update(shopData);
            } else {
                shopData.status = 'active'; // Default status for new shops
                await db.collection('shops').add(shopData);
            }
            closeModal();
            showToast('店家已儲存！');
            navigateTo('shops');
        } catch (error) {
            showErrorModal(error);
        }
    };

    const openCsvImportModal = () => {
        const title = '從 CSV 匯入店家';
        const requiredHeaders = ['name_zh-TW', 'name_en', 'type_zh-TW', 'type_en', 'address_zh-TW', 'address_en', 'phone', 'website', 'lat', 'lng', 'description_zh-TW', 'longDescription_zh-TW', 'tags'].join(', ');
        const formHtml = `
            <div class="space-y-4">
                <div>
                    <label for="csvFile" class="block text-sm font-medium text-gray-700">選擇 CSV 檔案</label>
                    <input type="file" id="csvFile" name="csvFile" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">CSV 格式要求：</h4>
                    <p class="text-sm text-gray-600">檔案必須是 UTF-8 編碼的 CSV 檔案，且第一行必須是標頭。標頭應包含以下欄位 (順序不拘，但建議使用)：</p>
                    <pre class="bg-gray-100 p-2 rounded-md text-xs mt-2 overflow-x-auto">${requiredHeaders}</pre>
                    <p class="text-sm text-gray-600 mt-2"><strong>注意：</strong></p>
                    <ul class="list-inside list-disc text-sm text-gray-600">
                        <li>如果 CSV 中包含 <code>id</code> 欄位且其值與現有店家相符，該店家將會被更新。</li>
                        <li>如果沒有 <code>id</code> 欄位或 <code>id</code> 為空，將會建立新店家。</li>
                        <li><code>tags</code> 欄位請用半形逗號 (,) 分隔多個標籤 ID。</li>
                    </ul>
                </div>
            </div>
        `;

        const handleUpload = () => {
            const fileInput = document.getElementById('csvFile');
            if (fileInput.files.length === 0) {
                return showErrorModal(new Error("請選擇一個檔案。"));
            }
            const file = fileInput.files[0];

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    ui.loadingIndicator.classList.remove('hidden');
                    try {
                        const shops = results.data;
                        if (shops.length === 0) {
                            throw new Error("CSV 檔案中沒有有效的資料。");
                        }

                        const batch = db.batch();
                        let importCount = 0;

                        shops.forEach(shop => {
                            // Basic validation
                            if (shop.name_zh_TW || shop.name_en) {
                                const shopId = shop.id ? shop.id.trim() : null;
                                let docRef;

                                if (shopId) {
                                    docRef = db.collection('shops').doc(shopId);
                                    // Don't overwrite status on update unless specified
                                    const { id, ...updateData } = shop;
                                    batch.update(docRef, updateData);
                                } else {
                                    docRef = db.collection('shops').doc();
                                    shop.status = 'active'; // Set default status for new shops
                                    batch.set(docRef, shop);
                                }
                                importCount++;
                            }
                        });

                        if (importCount === 0) {
                            throw new Error("CSV 中沒有可匯入的店家資料。請檢查欄位名稱是否正確。");
                        }

                        await batch.commit();
                        closeModal();
                        showToast(`成功匯入 ${importCount} 間店家。`);
                        navigateTo('shops');

                    } catch (error) {
                        showErrorModal(error);
                    } finally {
                        ui.loadingIndicator.classList.add('hidden');
                    }
                },
                error: (error) => {
                    showErrorModal(new Error(`CSV 解析失敗: ${error.message}`));
                }
            });
        };

        openModal(title, formHtml, handleUpload);
        ui.saveModalButton.textContent = '上傳並匯入';
    };
    
    const pageRenderers = {
        mainDashboard: async () => {
            ui.loadingIndicator.classList.remove('hidden');
            try {
                const shopsPromise = db.collection('shops').get();
                const subscribersPromise = db.collection('subscribers').get();

                const [shopsSnap, subscribersSnap] = await Promise.all([shopsPromise, subscribersPromise]);

                const totalShops = shopsSnap.size;
                const totalSubscribers = subscribersSnap.size;

                return `<h1 class="text-3xl font-bold mb-6">儀表板</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="p-6 bg-white rounded-lg shadow"><h2 class="text-lg font-medium text-gray-600">總訂閱數</h2><p class="text-4xl font-bold text-emerald-600 mt-2">${totalSubscribers}</p></div><div class="p-6 bg-white rounded-lg shadow"><h2 class="text-lg font-medium text-gray-600">總店家數</h2><p class="text-4xl font-bold text-blue-600 mt-2">${totalShops}</p></div></div>`;
            } finally {
                ui.loadingIndicator.classList.add('hidden');
            }
        },
        subscribers: async () => {
            const subscribersSnap = await db.collection('subscribers').orderBy('timestamp', 'desc').get();
            const subscribers = subscribersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return `<h1 class="text-3xl font-bold mb-6">訂閱者管理</h1><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="py-2 px-4 text-left">Email</th><th class="py-2 px-4 text-left">訂閱時間</th><th class="py-2 px-4 text-left">操作</th></tr></thead><tbody>${subscribers.map(s => `<tr><td class="py-2 px-4 border-b">${s.email}</td><td class="py-2 px-4 border-b">${s.timestamp?.toDate().toLocaleString() || 'N/A'}</td><td class="py-2 px-4 border-b"><button class="text-red-500 hover:text-red-700" data-action="delete-subscriber" data-id="${s.id}">刪除</button></td></tr>`).join('')}</tbody></table></div>`;
        },
        announcements: async () => {
            const doc = await db.collection('site_settings').doc('announcements').get();
            const content = doc.exists ? doc.data().content : '';
            return `<h1 class="text-3xl font-bold mb-6">公告管理</h1><div class="bg-white p-6 rounded-lg shadow"><label for="announcementsEditor" class="block text-lg font-medium mb-2">公告內容</label><textarea id="announcementsEditor" class="w-full h-48 p-3 border rounded">${content}</textarea><button id="saveAnnouncements" class="mt-4 px-4 py-2 text-white bg-emerald-600 rounded">儲存</button></div>`;
        },
        policies: async () => {
            const doc = await db.collection('site_settings').doc('policies').get();
            const data = doc.exists ? doc.data() : {};
            return `<h1 class="text-3xl font-bold mb-6">政策管理</h1><div class="bg-white p-6 rounded-lg shadow space-y-6"><div><label for="privacy" class="block text-lg font-medium mb-2">隱私權政策</label><textarea id="privacy" class="w-full h-48 p-3 border rounded">${data.privacy || ''}</textarea><button data-key="privacy" class="save-policy mt-2 px-4 py-2 text-white bg-emerald-600">儲存</button></div><div><label for="disclaimer" class="block text-lg font-medium mb-2">免責聲明</label><textarea id="disclaimer" class="w-full h-48 p-3 border rounded">${data.disclaimer || ''}</textarea><button data-key="disclaimer" class="save-policy mt-2 px-4 py-2 text-white bg-emerald-600">儲存</button></div></div>`;
        },
        shops: async () => {
            const shopsSnap = await db.collection('shops').where('status', '==', 'active').get();
            const shops = shopsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">店家管理</h1><div class="flex space-x-2"><button id="import-csv" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">從 CSV 匯入</button><button id="add-shop" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700">新增店家</button></div></div><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="py-2 px-4 text-left">店家名稱</th><th class="py-2 px-4 text-left">類型</th><th class="py-2 px-4 text-left">操作</th></tr></thead><tbody>${shops.map(s => `<tr><td class="py-2 px-4 border-b">${s['name_zh-TW']}</td><td class="py-2 px-4 border-b">${s['type_zh-TW']}</td><td class="py-2 px-4 border-b space-x-2"><button class="text-blue-500" data-action="edit-shop" data-id="${s.id}">編輯</button><button class="text-gray-600" data-action="delete-shop" data-id="${s.id}">移至垃圾桶</button></td></tr>`).join('')}</tbody></table></div>`;
        },
        trash: async () => {
            const shopsSnap = await db.collection('shops').where('status', '==', 'banned').get();
            const shops = shopsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return `<h1 class="text-3xl font-bold mb-6">垃圾桶</h1><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="py-2 px-4 text-left">店家名稱</th><th class="py-2 px-4 text-left">類型</th><th class="py-2 px-4 text-left">操作</th></tr></thead><tbody>${shops.map(s => `<tr><td class="py-2 px-4 border-b">${s['name_zh-TW']}</td><td class="py-2 px-4 border-b">${s['type_zh-TW']}</td><td class="py-2 px-4 border-b space-x-2"><button class="text-green-500" data-action="restore-shop" data-id="${s.id}">還原</button><button class="text-red-500" data-action="delete-shop-permanently" data-id="${s.id}">永久刪除</button></td></tr>`).join('')}</tbody></table></div>`;
        }
    };

    const navigateTo = async (sectionId) => {
        ui.loadingIndicator.classList.remove('hidden');
        try {
            ui.sidebarItems.forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            ui.mainContent.innerHTML = await pageRenderers[sectionId]();
        } catch(e) {
            showErrorModal(e);
            ui.mainContent.innerHTML = `<div class="text-red-500 p-4 bg-red-100 rounded">無法載入。請檢查錯誤彈窗以獲取詳細資訊。</div>`;
        } finally {
            ui.loadingIndicator.classList.add('hidden');
        }
    };
    
    const setupEventListeners = () => {
        document.getElementById('loginButton').addEventListener('click', login);
        ui.logoutButton.addEventListener('click', logout);
        ui.closeErrorModal.addEventListener('click', () => ui.errorModal.classList.add('hidden'));
        ui.closeModalButton.addEventListener('click', closeModal);
        ui.closeModalButtonX.addEventListener('click', closeModal);

        ui.sidebarItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.currentTarget.dataset.section); }));
        
        ui.mainContent.addEventListener('click', async (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const id = target.dataset.id;

            try {
                if (target.id === 'add-shop') { openShopForm(); }
                if (target.id === 'import-csv') { openCsvImportModal(); }
                if (action === 'edit-shop') { openShopForm(id); }
                if (action === 'delete-shop' && confirm(`確定要將此店家移至垃圾桶嗎？`)) {
                    await db.collection('shops').doc(id).update({ status: 'banned' });
                    showToast('店家已移至垃圾桶');
                    navigateTo('shops');
                }
                if (action === 'restore-shop' && confirm(`確定要還原此店家嗎？`)) {
                    await db.collection('shops').doc(id).update({ status: 'active' });
                    showToast('店家已還原');
                    navigateTo('trash');
                }
                if (action === 'delete-shop-permanently' && confirm(`注意：此操作將永久刪除店家，無法復原。確定嗎？`)) {
                    await db.collection('shops').doc(id).delete();
                    showToast('店家已永久刪除');
                    navigateTo('trash');
                }
                if (action === 'delete-subscriber' && confirm(`確定要刪除此訂閱者嗎？`)) {
                    await db.collection('subscribers').doc(id).delete();
                    showToast('訂閱者已刪除');
                    navigateTo('subscribers');
                }
                if (target.id === 'saveAnnouncements') {
                    const content = document.getElementById('announcementsEditor').value;
                    await db.collection('site_settings').doc('announcements').set({ content });
                    showToast('公告已儲存');
                }
                if (target.classList.contains('save-policy')) {
                    const key = target.dataset.key;
                    const value = document.getElementById(key).value;
                    await db.collection('site_settings').doc('policies').set({ [key]: value }, { merge: true });
                    showToast('政策已儲存');
                }
            } catch(error) { showErrorModal(error); }
        });
    };

    setupEventListeners();
    checkLogin();
});
</script>
</body>
</html>
